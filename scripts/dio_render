#!/usr/bin/env bash 
# https://devilgate.org/blog/2012/07/02/tip-using-pandoc-to-create-truly-standalone-html-files
: "${PATH_BASE:="$(git rev-parse --show-toplevel)"}" 
cd "${PATH_BASE}"/content
# https://github.com/pandoc/dockerfiles
for path_dir in $(find -type d -name "*" 2>/dev/null); do
  path_readme="${path_dir:2}"
  file_readme="${path_dir:2}"/README.md
  if [[ -f "${file_readme}" ]]; then
    title=$(sed -i -e '1 w /dev/stdout' "${file_readme}")
    title="${title:2}" 
    base=$(echo "${file_readme}" | awk -F "/" '{print $1}')
    if [[ "${base}" = "cs" ]]; then
      echo "cs"
      sed -i '1s/^/[vim](http://cs.divramod.io/vim) [git](http://cs.divramod.io/git)\n/' "${file_readme}" 
    fi 
    echo "title: ${title}" 
    echo "file_readme: ${file_readme}" 
    echo $(
      docker run \
        --rm \
        --volume "`pwd`:/data" \
        --volume "${PATH_BASE}/assets":"/assets" \
        pandoc/core:latest \
          --standalone \
          --metadata pagetitle="${title}" \
          --highlight-style haddock \
          -f markdown+hard_line_breaks \
          -t html5 \
          -A /assets/html/footer.html \
          -H /assets/css/github1.css \
          "${file_readme}"
    ) > "${path_readme}"/index.html
        # pandoc/latex:2.6 \
          # -H /css/github1.css \
          # -t slidy \
          # --wrap=preserve \
  fi 
done
